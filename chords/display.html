<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Display</title>
  <style>
    :root {
      color-scheme: dark light;
      font-family: sans-serif;
    }

    body,
    output {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1ch;
    }

    input,
    button {
      font-size: x-large;
      margin-left: 4ch;
    }

    .chord-output-row {
      display: grid;
      grid-template-columns: minmax(16ch, min-content) 1fr;
      gap: 2ch;
      align-items: center;
    }

    .chord-name {
      font-size: xx-large;
      display: block;
      text-align: end;
    }

    article {
      width: 120ch;
      max-width: 90vw;
      margin: auto;
      padding: 1ch;
      font-size: large;
      max-height: 90vh;
      overflow: auto;
    }

    article p {
      margin: 2ch 4ch;
    }

    table {
      width: 100%;
      margin: auto;
      gap: 1ch;
    }

    article h2 {
      margin-left: 1ch;
    }

    code {
      background: rgb(48 48 48);
      padding: 0.3ch;
      border-radius: 20%;
    }

    table code {
      margin-right: 1ch;
    }

    td:nth-child(4) svg {
      font-size: xx-small;
    }

    td:nth-child(4) .chord-name {
      font-size: medium;
    }
  </style>
</head>

<body>
  <nav>Display | <a href="./transpose.html">Transpose</a></nav>
  <h1>Display</h1>
  <article id="help" popover>
    <section>
      <h2>Chord Name Syntax</h2>
      <p>
        Chord names are <code>C D E F G A B</code>, accidentals can be specified
        with either ASCII <code>#</code> or <code>b</code> or Unicode
        <code>‚ôØ</code> or <code>‚ô≠</code> sharp and flat symbols.
      </p>
      <p>
        Any cluster of notes can be represented using a list of MIDI notes joined
        with commas. For example, <code>Cm</code>, <code>48,51,55</code> and
        <code>C3,Eb3,G3</code> all display the same chord.
      </p>
      <table id="chord-quality">
        <thead>
          <tr>
            <th scope="col">Chord Quality</th>
            <th scope="col">Symbol</th>
            <th scope="col">Integer Notation</th>
            <th scope="col">Example</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Major</td>
            <td><code></code></td>
            <td><code>0,4,7</code></td>
          </tr>
          <tr>
            <td>Minor</td>
            <td><code>m</code><code>-</code><code>min</code></td>
            <td><code>0,3,7</code></td>
          </tr>
          <tr>
            <td>Diminished</td>
            <td><code>o</code><code>dim</code></td>
            <td><code>0,3,6</code></td>
          </tr>
          <tr>
            <td>Augmented</td>
            <td><code>+</code><code>aug</code></td>
            <td><code>0,4,8</code></td>
          </tr>
          <tr>
            <td>Dominant</td>
            <td><code>7</code><code>dom7</code><code>Œî7</code></td>
            <td><code>0,4,7,10</code></td>
          </tr>
          <tr>
            <td>Minor Seven</td>
            <td><code>m7</code></td>
            <td><code>0,3,7,10</code></td>
          </tr>
          <tr>
            <td>Major Seven</td>
            <td><code>maj7</code><code>M7</code></td>
            <td><code>0,4,7,11</code></td>
          </tr>
          <tr>
            <td>Minor Major Seven</td>
            <td><code>mmaj7</code><code>mM7</code></td>
            <td><code>0,3,7,11</code></td>
          </tr>
          <tr>
            <td>Powerchord</td>
            <td><code>5</code></td>
            <td><code>0,7</code></td>
          </tr>
          <tr>
            <td>Suspended Second</td>
            <td><code>sus2</code></td>
            <td><code>0,2,7</code></td>
          </tr>
          <tr>
            <td>Suspended Fourth</td>
            <td><code>sus4</code></td>
            <td><code>0,5,7</code></td>
          </tr>
          <tr>
            <td>Diminished Seven</td>
            <td><code>o7</code><code>dim7</code></td>
            <td><code>0,3,6,9</code></td>
          </tr>
          <tr>
            <td>Half-Diminished</td>
            <td><code>m7b5</code></td>
            <td><code>0,3,6,10</code></td>
          </tr>
          <tr>
            <td>Diminished Major Seven</td>
            <td><code>omaj7</code><code>oM7</code><code>dimM7</code></td>
            <td><code>0,3,6,11</code></td>
          </tr>
          <tr>
            <td>Minor Flat Six</td>
            <td><code>mb6</code></td>
            <td><code>0,3,7,8</code></td>
          </tr>
          <tr>
            <td>Minor Six</td>
            <td><code>m6</code></td>
            <td><code>0,3,7,9</code></td>
          </tr>
          <tr>
            <td>Minor Add Nine</td>
            <td><code>madd9</code></td>
            <td><code>0,3,7,14</code></td>
          </tr>
          <tr>
            <td>Minor Add Eleven</td>
            <td><code>madd11</code></td>
            <td><code>0,3,7,17</code></td>
          </tr>
          <tr>
            <td>Seven Flat Five</td>
            <td><code>7b5</code></td>
            <td><code>0,4,6,10</code></td>
          </tr>
          <tr>
            <td>Six</td>
            <td><code>6</code></td>
            <td><code>0,4,7,9</code></td>
          </tr>
          <tr>
            <td>Add Nine</td>
            <td><code>add9</code></td>
            <td><code>0,4,7,14</code></td>
          </tr>
          <tr>
            <td>Add Eleven</td>
            <td><code>add11</code></td>
            <td><code>0,4,7,17</code></td>
          </tr>
          <tr>
            <td>Augmented Seven</td>
            <td><code>+7</code><code>aug7</code></td>
            <td><code>0,4,8,10</code></td>
          </tr>
          <tr>
            <td>Augmented Major Seven</td>
            <td><code>+maj7</code><code>augmaj7</code></td>
            <td><code>0,4,8,11</code></td>
          </tr>
          <tr>
            <td>Minor Nine</td>
            <td><code>m9</code></td>
            <td><code>0,3,7,10,14</code></td>
          </tr>
          <tr>
            <td>Minor Major Nine</td>
            <td><code>mmaj9</code><code>mM9</code></td>
            <td><code>0,3,7,11,14</code></td>
          </tr>
          <tr>
            <td>Six Nine</td>
            <td><code>6/9</code></td>
            <td><code>0,4,7,9,14</code></td>
          </tr>
          <tr>
            <td>Seven Six</td>
            <td><code>7/6</code></td>
            <td><code>0,4,7,9,10</code></td>
          </tr>
          <tr>
            <td>Nine</td>
            <td><code>9</code></td>
            <td><code>0,4,7,10,14</code></td>
          </tr>
          <tr>
            <td>Flat Nine</td>
            <td><code>7b9</code></td>
            <td><code>0,4,7,10,13</code></td>
          </tr>
          <tr>
            <td>Major Nine</td>
            <td><code>maj9</code><code>M9</code></td>
            <td><code>0,4,7,11,14</code></td>
          </tr>
          <tr>
            <td>Jazz Sus</td>
            <td><code>9sus4</code></td>
            <td><code>0,5,7,10,14</code></td>
          </tr>
        </tbody>
      </table>
    </section>
  </article>

  <div>
    <input id="chord-input" type="text" size="32" value="" placeholder="Type some chords" />
    <button popovertarget="help" popovertargetaction="show">?</button>
  </div>

  <output id="chord-output"></output>
  <svg xmlns="http://www.w3.org/2000/svg" width="60ch" height="10ch">
    <defs>
      <rect id="ivory" x="0" y="0" width="17ch" height="14ch" />
      <rect id="ebony" x="3ch" y="0" width="2ch" height="6.5ch" />
    </defs>
  </svg>

  <template id="chord-display">
    <div class="chord-output-row">
      <div class="chord-name"></div>
      <svg xmlns="http://www.w3.org/2000/svg" width="60ch" height="10ch">
        <g fill="ivory" stroke="gray">
          <use href="#ivory" data-note="48" />
          <use href="#ivory" x="4ch" data-note="50" />
          <use href="#ivory" x="8ch" data-note="52" />
          <use href="#ivory" x="12ch" data-note="53" />
          <use href="#ivory" x="16ch" data-note="55" />
          <use href="#ivory" x="20ch" data-note="57" />
          <use href="#ivory" x="24ch" data-note="59" />
          <use href="#ivory" x="28ch" data-note="60" />
          <use href="#ivory" x="32ch" data-note="62" />
          <use href="#ivory" x="36ch" data-note="64" />
          <use href="#ivory" x="40ch" data-note="65" />
          <use href="#ivory" x="44ch" data-note="67" />
          <use href="#ivory" x="48ch" data-note="69" />
          <use href="#ivory" x="52ch" data-note="71" />
          <use href="#ivory" x="56ch" data-note="72" />
        </g>
        <g fill="black" stroke="gray">
          <use href="#ebony" data-note="49" />
          <use href="#ebony" x="4ch" data-note="51" />
          <use href="#ebony" x="12ch" data-note="54" />
          <use href="#ebony" x="16ch" data-note="56" />
          <use href="#ebony" x="20ch" data-note="58" />
          <use href="#ebony" x="28ch" data-note="61" />
          <use href="#ebony" x="32ch" data-note="63" />
          <use href="#ebony" x="40ch" data-note="66" />
          <use href="#ebony" x="44ch" data-note="68" />
          <use href="#ebony" x="48ch" data-note="70" />
        </g>
      </svg>
    </div>
  </template>
  <script>///@ts-check
    'strict mode'
    /** @returns {any} */
    const getId = (/** @type {string} */ id) => document.getElementById(id)

    const /** @type {HTMLInputElement} */ input = getId('chord-input')
    const /** @type {HTMLOutputElement} */ output = getId('chord-output')
    const /** @type {HTMLTemplateElement} */ template = getId('chord-display')

    /** @returns {number} */
    function midiNumberToFrequency(/** @type {number} */ midi) {
      return 880 * 2 ** ((midi - 69) / 12)
    }

    const audioContext = new AudioContext({ latencyHint: 'playback' })
    const gain = new GainNode(audioContext, { gain: 0.5 })
    gain.connect(audioContext.destination)
    let playing = []
    function playPitches(/** @type {number[]} a list of MIDI numbers */ pitches) {
      playing.forEach((osc) => osc.stop())
      playing.length = 0
      gain.gain.value = 1 / (pitches.length + 1)
      for (const pitch of pitches) {
        const osc = new OscillatorNode(audioContext, {
          type: 'sine',
          frequency: midiNumberToFrequency(pitch),
        })
        osc.connect(gain)
        osc.start(0)
        osc.stop(audioContext.currentTime + 2)
        playing.push(osc)
      }
    }

    const qualities = {}

    for (const el of document.querySelectorAll('table#chord-quality>tbody>tr')) {
      const [_, symbols, notation] = el.children
      const integers = notation.children[0].textContent?.split(',').map(Number)
      for (const code of symbols.querySelectorAll('code')) {
        qualities[code.textContent] = integers
      }
      const td = document.createElement('td')
      //@ts-ignore
      appendKeyboard('C' + symbols.children[0].innerText, td)
      el.appendChild(td)
    }

    function canonical(/** @type {string} */ chordName) {
      if (chordName.includes(',')) {
        return chordName.split(',').filter(Boolean).map(canonical).join(',')
      } else if (chordName.includes('/')) {
        return chordName.split('/').filter(Boolean).map(canonical).join('/')
      } else if (chordName) {
        return chordName[0].toUpperCase() + chordName.slice(1)
          .replace(/#/g, '‚ôØ').replace(/b/g, '‚ô≠').replace('‚ôÆ', '')
      }
    }

    function rootToOffset(/** @type {string} */ root) {
      return { A: 57, B: 59, C: 48, D: 50, E: 52, F: 53, G: 55 }[root.toUpperCase()]
    }

    /** Convert a string of accidentals to its offset in semitones */
    function accidentalsToOffset(/** @type {string} */ accidentals) {
      return accidentals.split('').reduce((a, c) => a + ({ 'b': -1, '‚ô≠': -1, '‚ôØ': 1, '#': 1, 'ùÑ´': -2, 'ùÑ™': 2 }[c] || 0), 0)
    }

    function noteToPitch(/** @type {string} */ note) {
      const groups = note.match(/^(?<root>[a-gA-G])(?<accidentals>[b#ùÑ´ùÑ™‚ôØ‚ô≠‚ôÆ]*)(?<octave>[0-9])?$/)?.groups
      if (groups) {
        const octave = Number(groups.octave || 3) + 1
        return (rootToOffset(groups.root.toUpperCase()) % 12) + accidentalsToOffset(groups.accidentals) + 12 * octave
      } else if (/^\d+$/.test(note)) {
        return Number(note)
      }
    }

    /** @returns {number[]|undefined} */
    function chordToPitches(/** @type {string} */ chordName) {
      if (/,/.test(chordName)) {
        return chordName.split(',').map(noteToPitch).filter((x) => x >= 21 && x <= 108)
      }
      const chord = parseChord(chordName)
      if (chord && qualities[chord.quality]) {
        const root = noteToPitch(chord.root) + accidentalsToOffset(chord.accidentals)
        return qualities[chord.quality].map((x) => x + root)
      }
    }

    const /** @type {Record<string,number[]>} */ chordQualities = {}
    for (const { children } of document.querySelectorAll('table#chord-quality>tbody>tr')) {
      //@ts-ignore
      const semitones = children[2].children[0].textContent.split(',').map(Number)
      for (const suffix of children[1].children) {
        //@ts-ignore
        chordQualities[suffix.textContent] = semitones
      }
    }

    function parseChord(/** @type {string} */ chord) {
      const match = chord.match(/^(?<root>[a-gA-G])(?<accidentals>[#b‚ôØ‚ô≠‚ôÆ]*)(?<quality>.*?)(?:\/(?<slashroot>[a-gA-G])(?<slashaccidentals>[#b‚ôØ‚ô≠‚ôÆ]*))?$/u)
      if (match?.groups) {
        const result = match.groups
        return result
      }
    }

    function appendKeyboard(/** @type {string} */ chord, /** @type {HTMLElement} */ el) {
      const palette = [
        '#ff4040', '#11ee80', '#bf00bf', '#80ee11', '#4040ff', '#ee8011',
        '#00bfbf', '#ee1180', '#40ff40', '#8011ee', '#bfbf00', '#1180ee'
      ]
      const pitches = chordToPitches(chord)
      if (pitches) {
        const keyb = template.content.cloneNode(true)
        for (const pitch of pitches) {
          //@ts-ignore
          keyb.querySelector(`[data-note="${pitch}"]`)?.setAttribute('fill', palette[pitch % 12])
          //@ts-ignore
          keyb.querySelector(`div.chord-name`).innerText = canonical(chord)
        }
        el.appendChild(keyb)
        el.lastElementChild?.addEventListener('click', () => playPitches(pitches))
      }
    }

    //@ts-ignore
    const url = new URL(window.location)
    function updateChordList() {
      output.innerHTML = ""
      for (const chord of input.value.split(/\s+/).filter(Boolean)) {
        appendKeyboard(chord, output)
      }
      url.searchParams.set('c', input.value.trim().replace(/\s+/g, '_'))
      window.history.replaceState({}, '', url)
    }

    const params = new URLSearchParams(document.location.search)
    if (params.has('c')) {
      //@ts-ignore
      input.value = params.get('c').replace(/_+/g, ' ')
    }
    input.addEventListener('input', updateChordList)
    updateChordList()
    document.addEventListener('click', () => audioContext.resume(), { once: true, capture: true })
  </script>
</body>

</html>
